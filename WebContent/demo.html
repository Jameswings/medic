<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Demo</title>
<link href="jslib/extjs/resources/css/ext-all.css" rel="stylesheet" />
<link rel="stylesheet" type="text/css" href="jslib/extjs/ux/statusbar/css/statusbar.css" />
<script src="jslib/extjs/ext-all.js"></script>
<script type="text/javascript">
Ext.Loader.setConfig({
  enabled: true
});

Ext.Loader.setPath('Ext.ux', 'jslib/extjs/ux/');
Ext.require(['Ext.ux.statusbar.StatusBar']);
Ext.regModel('Medicgridmodel', {
  fields: [
    'name',
    'usage'
  ]
});

Ext.onReady(function(){
  Ext.tip.QuickTipManager.init();



  Ext.define('Ext.ux.NewDatePicker', {
    extend: 'Ext.picker.Date',
    requires: [
      'Ext.XTemplate',
      'Ext.button.Button',
      'Ext.window.Window'
    ],
    alias: 'widget.newdatepicker',
    renderTpl: [
      '<div id="{id}-innerEl" role="grid">',
      '<div role="presentation" class="{baseCls}-header">',
      // the href attribute is required for the :hover selector to work in IE6/7/quirks
      '<a id="{id}-prevEl" class="{baseCls}-prev {baseCls}-arrow" href="#" role="button" title="{prevText}" hidefocus="on" ></a>',
      '<div class="{baseCls}-month" id="{id}-middleBtnEl">{%this.renderMonthBtn(values, out)%}</div>',
      // the href attribute is required for the :hover selector to work in IE6/7/quirks
      '<a id="{id}-nextEl" class="{baseCls}-next {baseCls}-arrow" href="#" role="button" title="{nextText}" hidefocus="on" ></a>',
      '</div>',
      '<table id="{id}-eventEl" class="{baseCls}-inner" cellspacing="0" role="presentation">',
      '<thead role="presentation"><tr role="presentation">',
      '<tpl for="dayNames">',
      '<th role="columnheader" class="{parent.baseCls}-column-header" title="{.}" >',
      '<div class="{parent.baseCls}-column-header-inner">{.:this.firstInitial}</div>',
      '</th>',
      '</tpl>',
      '</tr></thead>',
      '<tbody role="presentation"><tr role="presentation">',
      '<tpl for="days">',
      '{#:this.isEndOfWeek}',
      '<td role="gridcell" id="{[Ext.id()]}" hiddenvalue>',
      // the href attribute is required for the :hover selector to work in IE6/7/quirks
      '<a role="presentation" hidefocus="on" class="{parent.baseCls}-date" href="#">/a>',
      '</td>',
      '</tpl>',
      '</tr></tbody>',
      '</table>',
      '<tpl if="showToday">',
      '<div id="{id}-footerEl" role="presentation" class="{baseCls}-footer">{%this.renderTodayBtn(values, out)%} {%this.renderDatingBtn(values, out)%}</div>',
      '</tpl>',
      '</div>',
      {
        firstInitial: function(value) {
          return Ext.picker.Date.prototype.getDayInitial(value);
        },
        isEndOfWeek: function(value) {
          // convert from 1 based index to 0 based
          // by decrementing value once.
          value--;
          var end = value % 7 === 0 && value !== 0;
          return end ? '</tr><tr role="row">' : '';
        },
        renderTodayBtn: function(values, out) {
          Ext.DomHelper.generateMarkup(values.$comp.todayBtn.getRenderTree(), out);
        },
        renderMonthBtn: function(values, out) {
          Ext.DomHelper.generateMarkup(values.$comp.monthBtn.getRenderTree(), out);
        },
        renderDatingBtn: function(values, out){
          Ext.DomHelper.generateMarkup(values.$comp.datingBtn.getRenderTree(), out);
        }
      }
    ],
    beforeRender: function () {
      var me = this;

      me.datingBtn = new Ext.button.Button({
        ownerCt: me,
        ownerLayout: me.getComponentLayout(),
        text: 'Appointment',
        tooltip: 'Appointment',
        tooltipType: 'title',
        handler: me.onDatingBtnClick,
        scope: me
      });

      me.callParent();

    },
    beforeDestroy : function() {
      var me = this;

      if (me.rendered) {
        Ext.destroy(
          me.datingBtn
        );
      }
      me.callParent();
    },
    finishRenderChildren: function () {
      var me = this;
      me.callParent();
      me.datingBtn.finishRender();
    },
    onDatingBtnClick: function(picker){
      window.open('./dating/index.html');
    },
    fullUpdate: function(date){
      var me = this,
        cells = me.cells.elements,
        textNodes = me.textNodes,
        disabledCls = me.disabledCellCls,
        eDate = Ext.Date,
        i = 0,
        extraDays = 0,
        visible = me.isVisible(),
        sel = +eDate.clearTime(date, true),
        today = +eDate.clearTime(new Date()),
        min = me.minDate ? eDate.clearTime(me.minDate, true) : Number.NEGATIVE_INFINITY,
        max = me.maxDate ? eDate.clearTime(me.maxDate, true) : Number.POSITIVE_INFINITY,
        ddMatch = me.disabledDatesRE,
        ddText = me.disabledDatesText,
        ddays = me.disabledDays ? me.disabledDays.join('') : false,
        ddaysText = me.disabledDaysText,
        format = me.format,
        days = eDate.getDaysInMonth(date),
        firstOfMonth = eDate.getFirstDateOfMonth(date),
        startingPos = firstOfMonth.getDay() - me.startDay,
        previousMonth = eDate.add(date, eDate.MONTH, -1),
        longDayFormat = me.longDayFormat,
        disabled,
        prevStart,
        current,
        disableToday,
        tempDate,
        setCellClass,
        html,
        cls,
        formatValue,
        value;

      if (startingPos < 0) {
        startingPos += 7;
      }

      days += startingPos;
      prevStart = eDate.getDaysInMonth(previousMonth) - startingPos;
      current = new Date(previousMonth.getFullYear(), previousMonth.getMonth(), prevStart, me.initHour);

      if (me.showToday) {
        tempDate = eDate.clearTime(new Date());
        disableToday = (tempDate < min || tempDate > max ||
          (ddMatch && format && ddMatch.test(eDate.dateFormat(tempDate, format))) ||
          (ddays && ddays.indexOf(tempDate.getDay()) != -1));

        if (!me.disabled) {
          me.todayBtn.setDisabled(disableToday);
          me.todayKeyListener.setDisabled(disableToday);
        }
      }

      setCellClass = function(cell, cls){
        disabled = false;
        value = +eDate.clearTime(current, true);
        cell.title = eDate.format(current, longDayFormat);
        cell.alt = eDate.format(current, 'Y-m-d');
        // store dateValue number as an expando
        cell.firstChild.dateValue = value;
        if(value == today){
          cls += ' ' + me.todayCls;
          cell.title = me.todayText;
        }
        if(value == sel){
          cls += ' ' + me.selectedCls;
          me.fireEvent('highlightitem', me, cell);
          if (visible && me.floating) {
            Ext.fly(cell.firstChild).focus(50);
          }
        }
        // disabling, once the cell is disabled we can short circuit
        // the other more expensive checks
        if(value < min) {
          cls += ' ' + disabledCls;
          cell.title = me.minText;
          disabled = true;
        }
        if (!disabled && value > max) {
          cls += ' ' + disabledCls;
          cell.title = me.maxText;
          disabled = true;
        }
        if (!disabled && ddays) {
          if(ddays.indexOf(current.getDay()) !== -1){
            cell.title = ddaysText;
            cls += ' ' + disabledCls;
            disabled = true;
          }
        }
        if(!disabled && ddMatch && format){
          formatValue = eDate.dateFormat(current, format);
          if(ddMatch.test(formatValue)){
            cell.title = ddText.replace('%0', formatValue);
            cls += ' ' + disabledCls;
          }
        }
        cell.className = cls + ' ' + me.cellCls;
      };

      for(; i < me.numDays; ++i) {
        if (i < startingPos) {
          html = (++prevStart);
          cls = me.prevCls;
        } else if (i >= days) {
          html = (++extraDays);
          cls = me.nextCls;
        } else {
          html = i - startingPos + 1;
          cls = me.activeCls;
        }
        textNodes[i].innerHTML = '<span style="vertical-align: top; width: 6px; font-size: 6pt; color: red;-webkit-text-size-adjust:none;" hiddenvalue="' + eDate.format(current, 'Y-m-d') + '">1 </span>' + html;
        current.setDate(current.getDate() + 1);
        setCellClass(cells[i], cls);
      }

      me.monthBtn.setText(Ext.Date.format(date, me.monthYearFormat));
    }
  });


  var required = '<span style="color:red;font-weight:bold" data-qtip="Required">*</span>',
      win, store, caseWin, historyWin, medicineWin;

  Ext.define('Ext.ux.MedicineGrid', {
    extend: 'Ext.grid.Panel',
    xtype: 'medicine-grid',
    requires: [
      'Ext.grid.feature.Grouping'
    ],
//    collapsible: true,
    iconCls: 'icon-grid',
    frame: true,
    width: 600,
    height: 400,
    flex: 1,
    header: false,

    // Need a minHeight. Neptune resizable framed panels are overflow:visible so as to
    // enable resizing handles to be embedded in the border lines.
    minHeight: 200,
//    resizable: true,

    features: [{
      ftype: 'grouping',
      groupHeaderTpl: '{name} ({rows.length} Case{[values.rows.length > 1 ? "s" : ""]})',
      hideGroupedHeader: true,
      startCollapsed: true,
      id: 'medicineGrouping'
    }],

    initComponent: function() {
      this.store = getMedicStore();
      this.columns = [{
        text: 'Name',
        flex: 1,
        dataIndex: 'name'
      }];

      this.callParent();

      var store = this.getStore(),
        groups = store.getGroups(),
        len = groups.length, i = 0,
        toggleMenu = [];

      this.groupingFeature = this.view.getFeature('medicineGrouping');

      // Create checkbox menu items to toggle associated group
      for (; i < len; i++) {
        toggleMenu[i] = {
          xtype: 'menucheckitem',
          text: groups[i].name,
          handler: this.toggleGroup,
          scope: this
        }
      }

      this.addDocked([{
        xtype: 'toolbar',
        items: ['->',
          {
            text: '功效分類',
            handler: function(){
              this.up('gridpanel').store.group('type1');
            }
          },
          {
            text: '用法分類',
            handler: function(){
              this.up('gridpanel').store.group('type2');
            }
          }
        ]
      }, {
        xtype: 'toolbar',
        ui: 'footer',
        dock: 'bottom',
        items: ['->', {
          text:'Apply',
          iconCls: 'icon-clear-group',
          scope: this,
          handler: function(){
            medicineWin.hide();
          }
        }]
      }]);

//      this.mon(this.store, 'groupchange', this.onGroupChange, this);
      this.mon(this.view, {
        groupcollapse: this.onGroupCollapse,
        groupexpand: this.onGroupExpand,
        scope: this
      });
    },

    onClearGroupingClick: function(){
      this.groupingFeature.disable();
    },

    toggleGroup: function(item) {
      var groupName = item.text;
      if (item.checked) {
        this.groupingFeature.expand(groupName, true);
      } else {
        this.groupingFeature.collapse(groupName, true);
      }
    },

    onGroupChange: function(store, groupers) {
      var grouped = store.isGrouped(),
        groupBy = groupers.items[0] ? groupers.items[0].property : '',
        toggleMenuItems, len, i = 0;

      // Clear grouping button only valid if the store is grouped
//      this.down('[text=Clear Grouping]').setDisabled(!grouped);

      // Sync state of group toggle checkboxes
      if (grouped && groupBy === 'cuisine') {
        toggleMenuItems = this.down('button[text=Toggle groups...]').menu.items.items;
        for (len = toggleMenuItems.length; i < len; i++) {
          toggleMenuItems[i].setChecked(
            this.groupingFeature.isExpanded(toggleMenuItems[i].text)
          );
        }
        this.down('[text=Toggle groups...]').enable();
      } else {
        this.down('[text=Toggle groups...]').disable();
      }
    },

    onGroupCollapse: function(v, n, groupName) {
      if (!this.down('[text=Toggle groups...]').disabled) {
        this.down('menucheckitem[text=' + groupName + ']').setChecked(false, true);
      }
    },

    onGroupExpand: function(v, n, groupName) {
      if (!this.down('[text=Toggle groups...]').disabled) {
        this.down('menucheckitem[text=' + groupName + ']').setChecked(true, true);
      }
    }
  });

  Ext.define('Ext.ux.GroupedGrid', {
    extend: 'Ext.grid.Panel',
    xtype: 'grouped-grid',
    requires: [
      'Ext.grid.feature.Grouping'
    ],
//    collapsible: true,
    iconCls: 'icon-grid',
    frame: true,
    width: 600,
    height: 400,

    // Need a minHeight. Neptune resizable framed panels are overflow:visible so as to
    // enable resizing handles to be embedded in the border lines.
    minHeight: 200,
    title: 'Cases Template',
    resizable: true,

    features: [{
      ftype: 'grouping',
      groupHeaderTpl: '{columnName}: {name} ({rows.length} Case{[values.rows.length > 1 ? "s" : ""]})',
      hideGroupedHeader: true,
      startCollapsed: true,
      id: 'restaurantGrouping'
    }],

    initComponent: function() {
      this.store = getCasesStore();
      this.columns = [{
        text: 'Name',
        flex: 1,
        dataIndex: 'name'
      },{
        text: 'Description',
        flex: 1,
        dataIndex: 'desc'
      }];

      this.callParent();

      var store = this.getStore(),
        groups = store.getGroups(),
        len = groups.length, i = 0,
        toggleMenu = [];

      this.groupingFeature = this.view.getFeature('restaurantGrouping');

      // Create checkbox menu items to toggle associated group
      for (; i < len; i++) {
        toggleMenu[i] = {
          xtype: 'menucheckitem',
          text: groups[i].name,
          handler: this.toggleGroup,
          scope: this
        }
      }

      this.addDocked([{
        xtype: 'toolbar',
        items: ['->', {
          text: 'Toggle groups...',
          destroyMenu: true,
          menu: toggleMenu
        }]
      }, {
        xtype: 'toolbar',
        ui: 'footer',
        dock: 'bottom',
        items: ['->', {
          text:'Apply',
          iconCls: 'icon-clear-group',
          scope: this,
          handler: function(){
            caseWin.hide();
          }
        }]
      }]);

      this.mon(this.store, 'groupchange', this.onGroupChange, this);
      this.mon(this.view, {
        groupcollapse: this.onGroupCollapse,
        groupexpand: this.onGroupExpand,
        scope: this
      });
    },

    onClearGroupingClick: function(){
      this.groupingFeature.disable();
    },

    toggleGroup: function(item) {
      var groupName = item.text;
      if (item.checked) {
        this.groupingFeature.expand(groupName, true);
      } else {
        this.groupingFeature.collapse(groupName, true);
      }
    },

    onGroupChange: function(store, groupers) {
      var grouped = store.isGrouped(),
        groupBy = groupers.items[0] ? groupers.items[0].property : '',
        toggleMenuItems, len, i = 0;

      // Clear grouping button only valid if the store is grouped
//      this.down('[text=Clear Grouping]').setDisabled(!grouped);

      // Sync state of group toggle checkboxes
      if (grouped) {
        toggleMenuItems = this.down('button[text=Toggle groups...]').menu.items.items;
        for (len = toggleMenuItems.length; i < len; i++) {
          toggleMenuItems[i].setChecked(
            this.groupingFeature.isExpanded(toggleMenuItems[i].text)
          );
        }
        this.down('[text=Toggle groups...]').enable();
      } else
        this.down('[text=Toggle groups...]').disable();

    },

    onGroupCollapse: function(v, n, groupName) {
      if (!this.down('[text=Toggle groups...]').disabled) {
        this.down('menucheckitem[text=' + groupName + ']').setChecked(false, true);
      }
    },

    onGroupExpand: function(v, n, groupName) {
      if (!this.down('[text=Toggle groups...]').disabled) {
        this.down('menucheckitem[text=' + groupName + ']').setChecked(true, true);
      }
    }
  });

  Ext.define('Ext.ux.MedicGrid', {
    extend: 'Ext.grid.Panel',
    xtype: 'medic-grid',
    requires: [
      'Ext.grid.feature.Grouping'
    ],
//    collapsible: true,
    iconCls: 'icon-grid',
    frame: true,
    width: 600,
    height: 400,

    // Need a minHeight. Neptune resizable framed panels are overflow:visible so as to
    // enable resizing handles to be embedded in the border lines.
    minHeight: 200,
    title: 'Medicine Template',
    resizable: true,

    features: [{
      ftype: 'grouping',
      groupHeaderTpl: '{columnName}: {name} ({rows.length} Case{[values.rows.length > 1 ? "s" : ""]})',
      hideGroupedHeader: true,
      startCollapsed: true,
      id: 'restaurantGrouping'
    }],

    initComponent: function() {
      this.store = getCasesStore();
      this.columns = [{
        text: 'Name',
        flex: 1,
        dataIndex: 'name'
      },{
        text: 'Description',
        flex: 1,
        dataIndex: 'desc'
      }];

      this.callParent();

      var store = this.getStore(),
        groups = store.getGroups(),
        len = groups.length, i = 0,
        toggleMenu = [];

      this.groupingFeature = this.view.getFeature('restaurantGrouping');

      // Create checkbox menu items to toggle associated group
      for (; i < len; i++) {
        toggleMenu[i] = {
          xtype: 'menucheckitem',
          text: groups[i].name,
          handler: this.toggleGroup,
          scope: this
        }
      }

      this.addDocked([{
        xtype: 'toolbar',
        items: ['->', {
          text: 'Toggle groups...',
          destroyMenu: true,
          menu: toggleMenu
        }]
      }, {
        xtype: 'toolbar',
        ui: 'footer',
        dock: 'bottom',
        items: ['->', {
          text:'Apply',
          iconCls: 'icon-clear-group',
          scope: this,
          handler: function(){
            caseWin.hide();
          }
        }]
      }]);

      this.mon(this.store, 'groupchange', this.onGroupChange, this);
      this.mon(this.view, {
        groupcollapse: this.onGroupCollapse,
        groupexpand: this.onGroupExpand,
        scope: this
      });
    },

    onClearGroupingClick: function(){
      this.groupingFeature.disable();
    },

    toggleGroup: function(item) {
      var groupName = item.text;
      if (item.checked) {
        this.groupingFeature.expand(groupName, true);
      } else {
        this.groupingFeature.collapse(groupName, true);
      }
    },

    onGroupChange: function(store, groupers) {
      var grouped = store.isGrouped(),
        groupBy = groupers.items[0] ? groupers.items[0].property : '',
        toggleMenuItems, len, i = 0;

      // Clear grouping button only valid if the store is grouped
      this.down('[text=Clear Grouping]').setDisabled(!grouped);

      // Sync state of group toggle checkboxes
      if (grouped && groupBy === 'cuisine') {
        toggleMenuItems = this.down('button[text=Toggle groups...]').menu.items.items;
        for (len = toggleMenuItems.length; i < len; i++) {
          toggleMenuItems[i].setChecked(
            this.groupingFeature.isExpanded(toggleMenuItems[i].text)
          );
        }
        this.down('[text=Toggle groups...]').enable();
      } else {
        this.down('[text=Toggle groups...]').disable();
      }
    },

    onGroupCollapse: function(v, n, groupName) {
      if (!this.down('[text=Toggle groups...]').disabled) {
        this.down('menucheckitem[text=' + groupName + ']').setChecked(false, true);
      }
    },

    onGroupExpand: function(v, n, groupName) {
      if (!this.down('[text=Toggle groups...]').disabled) {
        this.down('menucheckitem[text=' + groupName + ']').setChecked(true, true);
      }
    }
  });

  function getCasesStore(){
    var myData = [
      ['1', '傷風', '傷風感冒類', 'Description'],
      ['2', '熱感', '傷風感冒類', 'Description'],
      ['3', 'H5N1', '傷風感冒類', 'Description'],
      ['4', '頭暈', '頭暈身興類', 'Description'],
      ['5', '偏頭痛', '頭暈身興類', 'Description']
    ];

    return Ext.create('Ext.data.ArrayStore', {
      fields: [
        {name: 'id'},
        {name: 'name'},
        {name: 'group'},
        {name: 'desc'}
      ],
      groupField: 'group',
      sorters: {
        property : 'id',
        direction: 'ASC'
      },
      data: myData,
      pageSize: 8
    });
  }

  function getMedicStore(){
    var myData = [
      ['石斛', '清熱', '內服'],
      ['羅漢果', '清熱', '內服'],
      ['菊花', '解毒', '內服'],
      ['黨蔘', '養生', '內服'],
      ['枸杞', '養生', '內服'],
      ['板藍根', '解毒', '內服'],
      ['金銀花', '解毒', '外敷']
    ];

    return Ext.create('Ext.data.ArrayStore', {
      fields: [
        {name: 'name'},
        {name: 'type1'},
        {name: 'type2'}
      ],
      groupField: 'type1',
      sorters: {
        property : 'id',
        direction: 'ASC'
      },
      data: myData,
      pageSize: 100
    });
  }

  function showCases(){
    if (!caseWin){
      var caseGrid = Ext.create('Ext.ux.GroupedGrid');

      caseWin = Ext.widget('window', {
        title: 'Case template',
        closeAction: 'hide',
        width: 400,
        height: 500,
        minWidth: 300,
        minHeight: 300,
        layout: 'fit',
        resizable: true,
        modal: true,
        items: caseGrid
//        defaultFocus: 'firstName'
      });
    }
    caseWin.show();
  }

  function getPatientStore () {
    // Reverse order data should get sorted by the MemoryProxy
    var myData = [
      ['1', 'Craig', '09:12', '<span style="color:gray">Completed</span>'],
      ['2', 'Ian', '10:12', '<span style="color:gray">Completed</span>'],
      ['3', 'Ash', '10:50', '<span style="color:green;">Processing...</span>'],
      ['4', 'Kain', '10:56', '<span style="color:green;">Processing...</span>'],
      ['5', 'Martin', '-', 'Waiting call']
    ];

    return Ext.create('Ext.data.ArrayStore', {
      fields: [
        {name: 'id'},
        {name: 'name'},
        {name: 'time'},
        {name: 'status'}
      ],
      sorters: {
        property : 'id',
        direction: 'ASC'
      },
      data: myData,
      pageSize: 8
    });
  }


  function showContactForm() {
    if (!win) {
      var form = Ext.widget('form', {
        layout: {
          type: 'vbox',
          align: 'stretch'
        },
        border: false,
        bodyPadding: 10,

        fieldDefaults: {
          labelAlign: 'top',
          labelWidth: 100,
          labelStyle: 'font-weight:bold'
        },
        items: [{
          xtype: 'fieldcontainer',
          fieldLabel: 'Your Name',
          labelStyle: 'font-weight:bold;padding:0;',
          layout: 'hbox',
          defaultType: 'textfield',

          fieldDefaults: {
            labelAlign: 'top'
          },

          items: [{
            flex: 1,
            name: 'firstName',
            itemId: 'firstName',
            afterLabelTextTpl: required,
            fieldLabel: 'First',
            allowBlank: false
          }, {
            width: 30,
            name: 'middleInitial',
            fieldLabel: 'MI',
            margins: '0 0 0 5'
          }, {
            flex: 2,
            name: 'lastName',
            afterLabelTextTpl: required,
            fieldLabel: 'Last',
            allowBlank: false,
            margins: '0 0 0 5'
          }]
        }, {
          xtype: 'textfield',
          fieldLabel: 'Your Email Address',
          afterLabelTextTpl: required,
          vtype: 'email',
          allowBlank: false
        }, {
          xtype: 'textfield',
          fieldLabel: 'Company',
          afterLabelTextTpl: required,
          allowBlank: false
        }, {
          xtype: 'textareafield',
          fieldLabel: 'Note',
          labelAlign: 'top',
          flex: 1,
          margins: '0',
          afterLabelTextTpl: required,
          allowBlank: false
        }],

        buttons: [{
          text: 'Cancel',
          handler: function() {
            this.up('form').getForm().reset();
            this.up('window').hide();
          }
        }, {
          text: 'Save',
          handler: function() {
            if (this.up('form').getForm().isValid()) {
              // In a real application, this would submit the form to the configured url
              // this.up('form').getForm().submit();
              this.up('form').getForm().reset();
              this.up('window').hide();
              Ext.MessageBox.alert('System Info', 'User saved!');
            }
          }
        }]
      });

      win = Ext.widget('window', {
        title: 'User Info',
        closeAction: 'hide',
        width: 400,
        height: 400,
        minWidth: 300,
        minHeight: 300,
        layout: 'fit',
        resizable: true,
        modal: true,
        items: form,
        defaultFocus: 'firstName'
      });
    }
    win.show();
  }


  var view = Ext.create('Ext.Viewport', {
    layout: 'border',
    items: [{
      region: 'north',
      xtype: 'container',
      style: {backgroundImage: '-webkit-linear-gradient(top,#f3f6fc,#cbdaf0)'},
      html: '<h1 style="padding-left: 10px">Banner</h1>',
//        flex: 1,
      height: 52,
      layout: {
        type: 'hbox',
        align: 'middle'
      }
    }, {
      region: 'west',
      xtype: 'container',
      layout: 'fit',
      width: 250,
      split: true,
      splitterResize: false,
      stateful: true,
      stateId: 'mainnav.west',
      weight: 10,
      items: [
        {
          xtype:'container',
          width: '250',
          layout: {
            type: 'vbox',
//            pack: 'center',
            align : 'stretch',
            pack  : 'start'
          },
          defaults:{
            width: 250
          },
          items: [
            {
              xtype: 'newdatepicker',
              handler: function(picker, date) {
                Ext.Msg.alert('System Info', 'Search for day: ' + date);
              }
            },
            {
              xtype: 'gridpanel',
              title: 'Patients List',
              deferRowRender: false,
              flex: 1,
              store: getPatientStore(),
              columns: [
                {header: "ID",      flex: 1, dataIndex: 'id'},
                {header: "Name",    width: 80, dataIndex: 'name'},
                {header: "Time",    width: 45, dataIndex: 'time'},
                {header: "Status",  width: 80,  dataIndex: 'status'}
              ],
              loadMask: true,

              viewConfig: {
                stripeRows: true
              },
              tbar: [
                {
                  text: 'New User',
                  handler: showContactForm
                },
                '->',
                {
                  xtype: 'triggerfield',
                  emptyText : 'ID / Name',
                  onTrigger1Click: function(eOpts){
                    this.reset();
                  },
                  onTrigger2Click: function(eOpts){
                    Ext.Msg.alert('System Info', 'Search by: ' + this.getValue());
                  },
                  trigger1Cls: Ext.baseCSSPrefix + 'form-clear-trigger',
                  trigger2Cls: Ext.baseCSSPrefix + 'form-search-trigger'
                }
              ]
            }
          ]
        }
      ]
    }, {
      region: 'north',
      weight: 1,
      xtype: 'container',
      layout: 'fit',
      height: 280,
      items:[
        {
          xtype: 'form',
          anchor: '100%',
          tools: [
            {
              type:'left',
              tooltip: {
                width: 100,
                text: 'Apply from Case'
              },
              // hidden:true,
              handler: function(event, toolEl, panel){
                showCases();
              }
            }
          ],
          layout: 'fit',
//          collapsible: true,
          id: 'simpleForm',
          frame: true,
          title: 'User Form',
          bodyPadding: '5 5 0',
          width: 350,
          fieldDefaults: {
            msgTarget: 'side',
            labelWidth: 75
          },
          defaultType: 'textfield',
          items: [
            {
              xtype: 'fieldcontainer',
              layout: 'hbox',
              items: [
                {
                  xtype:'fieldset',
                  title: '基本信息',
                  defaultType: 'textfield',
                  layout: 'anchor',
                  flex: 2,
                  defaults: {
                    anchor: '100%'
                  },
                  items: [{
                    fieldLabel: 'ID',
                    name: 'id',
                    allowBlank: true,
                    tooltip: 'Enter your first name',
                    value: '20131412123',
                    readOnly: true
                  },{
                    fieldLabel: 'First Name',
                    name: 'first',
                    allowBlank: true,
                    tooltip: 'Enter your first name',
                    value: 'Ian',
                    readOnly: true
                  },{
                    fieldLabel: 'Last Name',
                    name: 'last',
                    allowBlank: true,
                    tooltip: 'Enter your last name',
                    value: 'Scholer',
                    readOnly: true
                  },{
                    fieldLabel: 'Company',
                    name: 'company',
                    tooltip: "Enter your employer's name",
                    value: 'IBM',
                    readOnly: true
                  }, {
                    fieldLabel: 'Email',
                    name: 'email',
                    allowBlank: true,
                    vtype:'email',
                    tooltip: 'Enter your email address',
                    value: 'Ian@ibm.com',
                    readOnly: true
                  }, {
                    fieldLabel: 'DOB',
                    name: 'dob',
                    xtype: 'datefield',
                    tooltip: 'Enter your date of birth',
                    value: '1982-11-21',
                    readOnly: true
                  }, {
                    fieldLabel: 'Age',
                    name: 'age',
                    xtype: 'numberfield',
                    minValue: 0,
                    maxValue: 100,
                    tooltip: 'Enter your age',
                    value: '31',
                    readOnly: true
                  }
                  ]
                },
                {
                  xtype: 'gridpanel',
                  title: 'History',
                  flex: 1.5,
                  height: 215,
                  padding: '8px',
                  showHistory: function(record){
                    if (!historyWin){
//                      var caseGrid = Ext.create('Ext.ux.GroupedGrid');

                      historyWin = Ext.widget('window', {
                        title: 'History Medical Record',
                        closeAction: 'hide',
                        width: 400,
                        height: 500,
                        minWidth: 300,
                        minHeight: 300,
                        layout: 'fit',
                        resizable: true,
                        modal: true,
                        items: [
                          {
                            html: 'show information here!'
                          }
                        ]
//        defaultFocus: 'firstName'
                      });
                    }
                    historyWin.show();
                  },
                  store: new Ext.data.Store({
                    fields:['name', 'time', 'mark'],
                    data:{'items':[
                      { 'name': 'Ian Scholar',  "time":"2010-07-12",  "mark":"长期治疗"  },
                      { 'name': 'Ian Scholar',  "time":"2010-07-19",  "mark":"" },
                      { 'name': 'Ian Scholar', "time":"2012-12-07",  "mark":""  },
                      { 'name': 'Ian Scholar', "time":"2013-03-15", "mark":""  }
                    ]},
                    proxy: {
                      type: 'memory',
                      reader: {
                        type: 'json',
                        root: 'items'
                      }
                    }
                  }),
                  columns: [
                    { text: 'Name',  dataIndex: 'name' },
                    { text: 'Time', dataIndex: 'time', flex: 1 },
                    { text: '診斷', dataIndex: 'mark' },
                    {
                      menuDisabled: true,
                      sortable: false,
                      xtype: 'actioncolumn',
                      dataIndex: 'mark',
                      flex:.5,
                      items: [
                        {
                          icon: 'jslib/extjs/resources/themes/images/default/tree/leaf.gif',
                          altText: 'Detail',  // Use a URL in the icon config
                          tooltip: 'Show details',
                          handler: function(grid, rowIndex, colIndex) {
                            var rec = grid.getStore().getAt(rowIndex);
//                            alert("Edit " + rec.get('firstname'));
                            grid.up('gridpanel').showHistory(rec);
                          }
                        }
                      ]
                    }

                  ],
                  listeners: {
                    itemdblclick: function(grid, record, item, index, e, eOpts ){
                      this.showHistory(record);
                    }
                  }
                }
              ]
            }
          ],

          buttons: [{
            text: 'Start Diagnosis',
            handler: function() {
              this.up('form').getForm().isValid();
            }
          },{
            text: 'Lock',
            handler: function() {
//              this.up('form').getForm().reset();
            }
          }]
        }
      ]

    },{
      region: 'center',
      weight: 5,
      xtype:'tabpanel',
      layout: 'fit',
      activeTab: 0,
      defaults :{
        autoScroll: true
      },
      items: [{
        title: '中藥',
        xtype: 'container',
        layout: 'hbox',
        items: [
          {
            xtype: 'gridpanel',
            flex: 2,
            plugins: [
              new Ext.grid.plugin.CellEditing({
                clicksToEdit: 1
              })
            ],
            store: new Ext.data.ArrayStore({
              // destroy the store if the grid is destroyed
              autoDestroy: true,
              fields: ['name', 'usage'],
              data: [
                ['石斛', '50 mg'],
                ['板藍根', '5 mg'],
                ['金銀花', '5 g'],
                ['羅漢果', '1 個']
              ],
              pageSize: 30
            }),
            columns: [{
              header: '品名',
              dataIndex: 'name',
              flex: 10,
              allowBlank: false,
              editor: new Ext.form.field.ComboBox({
                typeAhead: true,
                triggerAction: 'all',
                selectOnTab: true,
                store: [
                  ['石斛','石斛'],
                  ['羅漢果','羅漢果'],
                  ['菊花','菊花'],
                  ['黨蔘','黨蔘'],
                  ['枸杞','枸杞'],
                  ['板藍根','板藍根'],
                  ['金銀花','金銀花']
                ],
                lazyRender: true,
                listClass: 'x-combo-list-small'
              })
            }, {
              header: '用法',
              dataIndex: 'usage',
              flex: 20,
//              align: 'right',
              editor: {
                allowBlank: false
              }
            }],
            selModel: {
              selType: 'cellmodel'
            },
            tbar: [{
              text: '增加一條',
              handler: function(){

                var rec = new Medicgridmodel({
                  name: '',
                  usage: '...'
                });
                console.log(rec);

                this.up('gridpanel').getStore().insert(0, rec);
//                this.cellEditing.startEditByPosition({
//                  row: 0,
//                  column: 0
//                });
              }
            },'->', {
              text: '藥名查詢',
              handler: function(){
                if (!medicineWin) {
                  var grid = new Ext.ux.MedicineGrid();
                  medicineWin = Ext.widget('window', {
                      title: '藥名查詢',
                      closeAction: 'hide',
                      width: 400,
                      height: 500,
                      minWidth: 300,
                      minHeight: 300,
                      layout: 'fit',
                      resizable: true,
                      modal: true,
                      items: grid
//        defaultFocus: 'firstName'
                    });
                }
                medicineWin.show();
              }
            }]
          }
        ]
      },{
        title: '西藥',
        html: "Search form!."
      },{
        title: '中成藥',
        html: "Search form!."
      },{
        title: 'And so on...',
        listeners: {
          activate: function(tab){

          }
        },
        html: "Some other info"
      }
      ]
    }, {
      region: 'east',
      id: 'east-region',
      title: 'Medical Record',
      width: 250,
      autoScroll: true,
      tools:[
        {
          type: 'maximize',
          tooltip: 'Maximize',
          handler: function(){
            var preview = this.up('panel'),
              code = preview.getEl().down('.prettyprint').dom.innerHTML;

            var w = new Ext.window.Window({
              autoShow: true,
              title: 'Preview',
              tools: [
                {
                  type:'print',
                  tooltip: {
                    width: 100,
                    text: 'Print Page'
                  },
                  // hidden:true,
                  handler: function(event, toolEl, panel){
                    Ext.Msg.alert('System Info', 'Paper printing...')
                  }
                }
              ],
              modal: true,
              cls: 'preview-container',
              autoScroll: true,
              html: '<pre class="prettyprint">' + code + '</pre>'
            });
            w.maximize();
          }
        },
        {
          type:'print',
          tooltip: {
            width: 100,
            text: 'Print Page'
          },
          // hidden:true,
          handler: function(event, toolEl, panel){
            Ext.Msg.alert('System Info', 'Paper printing...')
          }
        }
      ],
      weight: 5,
      html: '<div class="prettyprint">這裡模擬紙質病歷</div>'
//        stateful: true,
//        stateId: 'mainnav.east',
//        split: true,
//        collapsible: true,
//        layout: {
//            type: 'vbox',
//            align: 'stretch'
//        },
//        width: 250,
//        items: [{
//            xtype: 'descriptionPanel',
//            stateful: true,
//            stateId: 'mainnav.east.description',
//            height: 200
//        }, {
//            xtype: 'splitter',
//            collapsible: true,
//            collapseTarget: 'prev'
//        }, {
//            xtype: 'codePreview',
//            flex: 1
//        }]
    },{
      region: 'south',
      xtype: 'container',
      layout: 'fit',
      weight: 20,
      height: 28,
      border: false,
      items: Ext.create('Ext.ux.StatusBar', {
        defaultText: 'Default status',
        id: 'right-statusbar',
//        statusAlign: 'right', // the magic config
        text: 'Ready',
        iconCls: 'x-status-valid',
        items: [{
          text: 'A Button'
        }, '-', 'Plain Text', ' ', ' ']
      })
    }]
  });
});
</script>
</head>
<body>

</body>
</html>